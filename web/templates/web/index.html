<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0d6efd" />
  <title>Ajuste de Estoque</title>
  {% load static %}
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <style>
    :root{
      --gap:16px;
      --radius:12px;
      --border:#ddd;
      --muted:#666;
      --ok:#0a7;
      --err:#b00;
      --primary:#111;
      --light:#fff;
    }

    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      margin:0;
      padding:16px;
      line-height:1.35;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .row{display:flex; gap:var(--gap); align-items:flex-start; flex-wrap:wrap;}
    .col{flex:1 1 420px; min-width:280px}

    input,button,select{
      font-size:16px;
      padding:12px;
      height:44px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    input,select{width:100%}

    .rowline{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }

    .btn{
      border:1px solid var(--primary);
      border-radius:var(--radius);
      background:var(--primary);
      color:var(--light);
      cursor:pointer;
      min-width:110px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn:hover{opacity: 0.9;}
    .btn.light{background:var(--light);color:var(--primary);}
    .btn:active{transform:scale(.98)}

    ul{
      list-style:none;
      padding:0;
      margin:10px 0 0;
      max-height: 45vh;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: var(--light);
    }

    li{
      padding:12px;
      border-bottom:1px solid #eee;
      cursor:pointer;
      transition: background 0.2s ease;
    }

    li:hover{background: #f8f9fa;}
    li:last-child{border-bottom:0}

    .muted{color:var(--muted)}
    .ok{color:var(--ok); font-weight:600}
    .err{color:var(--err); font-weight:600}

    .pill{
      padding:4px 12px;
      background:#06c;
      color:#fff;
      border-radius:999px;
      font-size:12px;
      font-weight: 500;
    }

    .small-btn {
      padding:8px 12px;
      height:auto;
      border-radius:8px;
      font-size:14px;
      min-width:0;
      cursor:pointer
    }

    .badge-current {
      background:#222;
      color:#fff;
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      display:inline-block
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-area {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .search-section {
      background: var(--light);
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .overlay {
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background: rgba(0,0,0,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding: 20px;
    }

    .modal {
      width:100%;
      max-width: 400px;
      background:#fff;
      border-radius:16px;
      padding:24px;
      box-shadow:0 10px 40px rgba(0,0,0,0.4);
    }

    .modal h3 {
      margin:0 0 16px 0;
      font-size:20px;
      text-align: center;
      font-weight: 600;
    }

    .modal .note {
      color:#666;
      font-size:14px;
      margin-bottom:20px;
      text-align: center;
      line-height: 1.4;
    }

    .modal .actions {
      display:flex;
      gap:8px;
      justify-content:center;
      margin-top:20px;
    }

    .modal input, .modal select {
      height:44px;
      font-size:16px;
      padding:8px 12px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      width: 100%;
    }

    .modal label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }

    .modal .err {
      color:var(--err);
      margin-top:8px;
      font-weight:600;
      text-align: center;
      font-size: 14px;
    }

    .product-detail {
      background: var(--light);
      border-radius: var(--radius);
      padding: 20px;
    }

    .stock-info {
      background: #f8f9fa;
      padding: 16px;
      border-radius: var(--radius);
      margin: 16px 0;
      border-left: 4px solid #06c;
    }

    .adjustment-section {
      margin-top: 20px;
    }

    .adjustment-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .quantity-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 20px 0;
      justify-content: center;
    }

    .quantity-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      border: 2px solid var(--primary);
      background: var(--light);
      color: var(--primary);
      cursor: pointer;
    }

    input.quantity-display {
      font-size: 24px;
      font-weight: bold;
      min-width: 60px;
      text-align: center;
      padding: 8px 12px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--light);
      height: 44px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    input.quantity-display::-webkit-outer-spin-button,
    input.quantity-display::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input.quantity-display[type=number] {
      -moz-appearance: textfield;
    }

    @media (max-width: 768px){
      body{margin:0;padding:12px;}

      .modal {
        width:100%;
        max-width: none;
        margin: 0;
        border-radius: 16px;
      }

      .overlay {
        padding: 16px;
        align-items: flex-start;
        padding-top: 20%;
      }

      .header {
        flex-direction: column;
        align-items: stretch;
      }

      .header-title {
        justify-content: space-between;
      }

      .user-area {
        justify-content: center;
        margin-top: 8px;
      }

      .rowline {
        flex-direction: column;
      }

      .rowline > * {
        width: 100%;
      }

      .adjustment-actions {
        flex-direction: column;
      }

      .adjustment-actions .btn {
        width: 100%;
      }

      .quantity-controls {
        gap: 8px;
      }

      .quantity-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }

      input.quantity-display {
        font-size: 20px;
        min-width: 50px;
      }

      #empresa {
        width: 100% !important;
        max-width: 100%;
        font-size: 14px;
      }
      
      .search-section > div:first-child {
        flex-direction: column;
        align-items: stretch !important;
      }
      
      .search-section > div:first-child label {
        margin-bottom: 6px;
      }
    }

    a,button{-webkit-tap-highlight-color:transparent}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        <span style="display:flex; gap:12px; align-items:center;">
          <span>Ajuste de Estoque — API online</span>
          <span class="pill">Ello</span>
        </span>
      </div>

      <div class="user-area">
        <span id="currentUserBadge" class="badge-current" style="display:none"></span>
        <button id="btnLogoutTop" class="btn light small-btn" style="display:none;">Sair</button>
        <button id="btnOpenLogin" class="btn light small-btn">Entrar</button>
      </div>
    </div>

    <div class="row">
      <!-- BUSCA -->
      <div class="col">
        <div class="search-section">
          <div style="margin-bottom:12px; display:flex; align-items:center; gap:8px">
            <label for="empresa" style="font-weight:600; color:#333">Empresa:</label>
            <select id="empresa" style="width:300px; font-weight:600; font-size:16px">
              <option value="">Carregando empresas...</option>
            </select>
          </div>
          
          <div class="rowline">
            <input id="q" type="search" inputmode="search" autocomplete="off"
               placeholder="Descrição (ex.: coca) ou código de barras…" style="flex:1" />
            <button id="btnBuscar" class="btn">Buscar</button>
          </div>
          
          <div class="muted" style="margin-top:8px; font-size:14px">
            Digite o nome do produto ou o código de barras e clique em Buscar.
          </div>
        </div>

        <ul id="lista"></ul>
      </div>

      <!-- DETALHE + AJUSTE -->
      <div class="col">
        <div class="product-detail">
          <div id="detalhe" class="muted">Selecione um produto à esquerda…</div>
          <div id="ajuste" style="display:none">
            <hr style="margin:20px 0">

            <div class="adjustment-section">
              <h3 style="margin: 0 0 16px 0; font-size: 18px; text-align: center;">Ajuste de Quantidade</h3>

              <div class="quantity-controls">
                <button id="btnDecrease" class="quantity-btn" type="button">−</button>
                <input id="quantityDisplay" class="quantity-display" type="number" min="1" step="1" value="1" inputmode="numeric" aria-label="Quantidade" />
                <button id="btnIncrease" class="quantity-btn" type="button">+</button>
              </div>

              <div class="adjustment-actions">
                <button id="btnAdd" class="btn">Adicionar</button>
                <button id="btnRem" class="btn light">Remover</button>
              </div>
            </div>

            <div id="msg" style="margin-top:20px; min-height: 20px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Login -->
    <div id="loginOverlay" class="overlay" style="display:none">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
        <h3 id="loginTitle">Login</h3>
        <div class="note">
          Informe usuário e senha (somente usuários ATIVOS)
        </div>

        <div>
          <label for="modalUsuario">Usuário</label>
          <select id="modalUsuario">
            <option value="">Carregando usuários…</option>
          </select>
        </div>

        <div>
          <label for="modalSenha">Senha</label>
          <input id="modalSenha" type="password" placeholder="Digite sua senha" autocomplete="current-password">
        </div>

        <div id="loginError" class="err" style="display:none"></div>

        <div class="actions">
          <button id="btnCancelLogin" class="btn light">Cancelar</button>
          <button id="btnModalLogin" class="btn">Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
/* ====== CONFIG ====== */
const API_BASE = `${location.origin}/api/estoque`;
const USERS_API = `${location.origin}/api/usuarios/`;
const USERS_AUTH_API = `${location.origin}/api/usuarios/auth/`;
const EMPRESAS_API = `${location.origin}/api/empresas/`;

/* ====== ELEMENTS ====== */
const empresaSelect = document.getElementById('empresa');
const lista = document.getElementById('lista');
const q = document.getElementById('q');
const detalhe = document.getElementById('detalhe');
const ajusteBox = document.getElementById('ajuste');
const quantityDisplay = document.getElementById('quantityDisplay');
const msg = document.getElementById('msg');

const loginOverlay = document.getElementById('loginOverlay');
const modalUsuario = document.getElementById('modalUsuario');
const modalSenha = document.getElementById('modalSenha');
const btnModalLogin = document.getElementById('btnModalLogin');
const btnCancelLogin = document.getElementById('btnCancelLogin');
const loginError = document.getElementById('loginError');

const currentUserBadge = document.getElementById('currentUserBadge');
const btnOpenLogin = document.getElementById('btnOpenLogin');
const btnLogoutTop = document.getElementById('btnLogoutTop');

const btnIncrease = document.getElementById('btnDecrease');
const btnDecrease = document.getElementById('btnIncrease');
const btnAdd = document.getElementById('btnAdd');
const btnRem = document.getElementById('btnRem');
const btnBuscar = document.getElementById('btnBuscar');

/* ====== STATE ====== */
let produtoSel = null;
let quantidadeAtual = 1;
const pendingItems = [];

/* ====== HELPERS ====== */
const fmt = n => (Math.round((Number(n)||0)*100)/100).toFixed(2).replace('.', ',');

function setCurrentUser(id, label) {
  if (id) {
    localStorage.setItem('ajuste_usuario_id', String(id));
    localStorage.setItem('ajuste_usuario_label', String(label || id));
    currentUserBadge.textContent = label || id;
    currentUserBadge.style.display = 'inline-block';
    btnLogoutTop.style.display = 'inline-block';
    btnOpenLogin.style.display = 'none';
  } else {
    localStorage.removeItem('ajuste_usuario_id');
    localStorage.removeItem('ajuste_usuario_label');
    currentUserBadge.style.display = 'none';
    btnLogoutTop.style.display = 'none';
    btnOpenLogin.style.display = '';
  }
}

function getSavedUser(){ 
  const id = localStorage.getItem('ajuste_usuario_id'); 
  const label = localStorage.getItem('ajuste_usuario_label'); 
  return id ? { id: id, label: label } : null; 
}

/* ====== PENDING UI (LOTE) ====== */
function ensurePendingUI(){
  if (document.getElementById('pendingBox')) return;
  const container = document.createElement('div');
  container.id = 'pendingBox';
  container.style.marginTop = '16px';
  container.innerHTML = `
    <h4 style="margin:0 0 8px 0">Itens pendentes (lote)</h4>
    <ul id="pendingList" style="padding-left:12px; margin:0"></ul>
    <div style="margin-top:12px; display:flex; gap:8px">
      <button id="btnConfirmLote" class="btn" style="display:none">Confirmar ajustes</button>
      <button id="btnClearPending" class="btn light" style="display:none">Limpar</button>
    </div>
  `;
  ajusteBox.parentNode.appendChild(container);

  document.getElementById('btnConfirmLote').addEventListener('click', confirmarLote);
  document.getElementById('btnClearPending').addEventListener('click', () => { pendingItems.length = 0; renderPending(); });
}

function renderPending(){
  ensurePendingUI();
  const list = document.getElementById('pendingList');
  const btnConfirmLote = document.getElementById('btnConfirmLote');
  const btnClearPending = document.getElementById('btnClearPending');

  if (!pendingItems.length) {
    list.innerHTML = '<li class="muted">Nenhum item pendente.</li>';
    btnConfirmLote.style.display = 'none';
    btnClearPending.style.display = 'none';
    return;
  }

  btnConfirmLote.style.display = 'inline-block';
  btnClearPending.style.display = 'inline-block';
  list.innerHTML = '';
  pendingItems.forEach((it, i) => {
    const li = document.createElement('li');
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.alignItems = 'center';
    li.style.paddingRight = '8px';
    li.innerHTML = `<div><strong>${it.descricao}</strong><div class="muted" style="font-size:13px">#${it.idproduto} • delta: ${it.delta}</div></div>`;
    const right = document.createElement('div');
    right.style.display = 'flex';
    right.style.gap = '8px';
    const btnRm = document.createElement('button');
    btnRm.className = 'btn light small-btn';
    btnRm.textContent = 'Rem';
    btnRm.onclick = () => { pendingItems.splice(i,1); renderPending(); };
    right.appendChild(btnRm);
    li.appendChild(right);
    list.appendChild(li);
  });
}

/* ====== LOGIN ====== */
async function carregarUsuariosModal(){
  modalUsuario.innerHTML = '<option value="">Carregando...</option>';
  try {
    const r = await fetch(USERS_API);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const js = await r.json();
    modalUsuario.innerHTML = '<option value="">Selecione usuário...</option>';
    let arr = [];
    if (Array.isArray(js)) arr = js;
    else if (js && Array.isArray(js.results)) arr = js.results;
    else if (js && Array.isArray(js.data)) arr = js.data;
    arr.forEach(u=>{
      const id = u.id ?? u.IDUSUARIO ?? u.idusuario ?? u.ID ?? u.usuario;
      const name = (u.nome || u.nomecompleto || u.username || u.USUARIO || u.user || u.NOME || u.NOME_COMPLETO || '').toString();
      const label = name || String(id);
      const opt = document.createElement('option');
      opt.value = id ?? '';
      opt.textContent = label;
      opt.dataset.label = label;
      modalUsuario.appendChild(opt);
    });
    const saved = getSavedUser();
    if (saved) {
      const found = Array.from(modalUsuario.options).find(o => String(o.value) === String(saved.id));
      if (found) modalUsuario.value = saved.id;
    }
  } catch(e){
    console.warn('Falha ao carregar usuários (modal):', e);
    modalUsuario.innerHTML = '<option value="">(não foi possível carregar)</option>';
  }
}

/* ====== CARREGAR EMPRESAS ====== */
async function carregarEmpresas(){
  empresaSelect.innerHTML = '<option value="">Carregando...</option>';
  try {
    const r = await fetch(EMPRESAS_API);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const js = await r.json();
    
    empresaSelect.innerHTML = '<option value="">Selecione a empresa...</option>';
    
    let arr = [];
    if (Array.isArray(js)) arr = js;
    else if (js && Array.isArray(js.results)) arr = js.results;
    else if (js && Array.isArray(js.data)) arr = js.data;
    
    arr.forEach(emp => {
      const codigo = emp.codigo || emp.CODIGO;
      const nome = emp.nome || emp.NOMEFANTASIA || emp.nomefantasia || '';
      const razao = emp.razaosocial || emp.RAZAOSOCIAL || '';
      const label = razao || nome || `Empresa ${codigo}`;
      
      const opt = document.createElement('option');
      opt.value = codigo;
      opt.textContent = `${codigo} - ${label}`;
      empresaSelect.appendChild(opt);
    });
    
    empresaSelect.value = '1';
  } catch(e){
    console.warn('Falha ao carregar empresas:', e);
    empresaSelect.innerHTML = '<option value="1">1 - (Não foi possível carregar)</option>';
    empresaSelect.value = '1';
  }
}

async function tryServerAuth(payload){
  try {
    const r = await fetch(USERS_AUTH_API, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const ct = r.headers.get('content-type')||'';
    let js = {};
    if (ct.includes('application/json')) js = await r.json();
    if (r.ok) return { ok: true, data: js };
    return { ok:false, message: js.detail || js.message || r.statusText, status: r.status };
  } catch(err){
    console.error('Erro ao autenticar:', err);
    return { ok:false, message:'Falha ao conectar com o servidor.' };
  }
}

async function doLogin(){
  loginError.style.display = 'none';
  loginError.textContent = '';
  
  const sel = modalUsuario.value && modalUsuario.selectedOptions[0];
  const usuarioId = sel ? sel.value : (modalUsuario.value || '').trim();
  const usuarioLabel = sel ? (sel.dataset.label || sel.textContent) : usuarioId;
  const senha = modalSenha.value || '';
  
  if (!usuarioId) {
    loginError.textContent = 'Selecione um usuário.';
    loginError.style.display = 'block';
    return false;
  }
  
  if (!senha) {
    loginError.textContent = 'Digite a senha.';
    loginError.style.display = 'block';
    modalSenha.focus();
    return false;
  }

  btnModalLogin.disabled = true;
  btnModalLogin.textContent = 'Entrando...';
  
  try {
    const auth = await tryServerAuth({ username: usuarioId, password: senha });
    
    if (auth.ok){
      const data = auth.data || {};
      const label = data.nome || data.username || usuarioLabel;
      setCurrentUser(data.id ?? usuarioId, label);
      hideLoginModal();
      return true;
    } else {
      if (auth.status === 401 || auth.status === 403) {
        loginError.textContent = 'Senha incorreta. Tente novamente.';
      } else if (auth.status === 404) {
        loginError.textContent = 'Usuário não encontrado.';
      } else {
        loginError.textContent = auth.message || 'Erro ao fazer login. Verifique suas credenciais.';
      }
      loginError.style.display = 'block';
      modalSenha.value = '';
      modalSenha.focus();
      return false;
    }
  } catch(err) {
    loginError.textContent = 'Erro ao conectar com o servidor.';
    loginError.style.display = 'block';
    return false;
  } finally {
    btnModalLogin.disabled = false;
    btnModalLogin.textContent = 'Entrar';
  }
}

function showLoginModal(){ 
  loginError.style.display = 'none'; 
  loginError.textContent=''; 
  modalSenha.value=''; 
  loginOverlay.style.display = 'flex'; 
  setTimeout(()=> modalUsuario.focus(), 60); 
}

function hideLoginModal(){ loginOverlay.style.display = 'none'; }

function logoutAndShowLogin(){ 
  setCurrentUser(null); 
  carregarUsuariosModal().finally(()=> showLoginModal()); 
}

/* ====== QUANTIDADE EDITÁVEL ====== */
function updateQuantityDisplay(){
  quantidadeAtual = Number.isInteger(quantidadeAtual) ? quantidadeAtual : parseInt(quantidadeAtual, 10) || 1;
  if (quantidadeAtual < 1) quantidadeAtual = 1;
  quantityDisplay.value = String(quantidadeAtual);
}

function getQuantityFromInput(){
  let v = parseInt(quantityDisplay.value, 10);
  if (!Number.isFinite(v) || isNaN(v)) v = 1;
  if (v < 1) v = 1;
  quantidadeAtual = v;
  quantityDisplay.value = String(quantidadeAtual);
  return quantidadeAtual;
}

function increaseQuantity(){ 
  getQuantityFromInput(); 
  quantidadeAtual = quantidadeAtual + 1; 
  updateQuantityDisplay(); 
}

function decreaseQuantity(){ 
  getQuantityFromInput(); 
  if (quantidadeAtual > 1){ 
    quantidadeAtual = quantidadeAtual - 1; 
    updateQuantityDisplay(); 
  } 
}

quantityDisplay.addEventListener('input', () => {
  const t = quantityDisplay.value.replace(/[^\d-]/g, '');
  quantityDisplay.value = t;
});

quantityDisplay.addEventListener('blur', () => { getQuantityFromInput(); });

quantityDisplay.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { 
    e.preventDefault(); 
    getQuantityFromInput(); 
    btnAdd.focus(); 
  }
});

/* ====== BUSCAR PRODUTOS ====== */
async function buscar(){
  const url = `${API_BASE}/produtos/?limit=25&query=${encodeURIComponent(q.value||'')}`;
  lista.innerHTML = '<li>Carregando…</li>';
  try {
    const r = await fetch(url);
    const ct = r.headers.get('content-type') || '';
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    if (!ct.includes('application/json')) throw new Error('Resposta não-JSON');
    const js = await r.json();
    const results = js.results || js;
    if (!Array.isArray(results) || results.length === 0) {
      lista.innerHTML = '<li>Nenhum produto encontrado.</li>';
      return;
    }
    lista.innerHTML = '';
    results.forEach(p=>{
      const li = document.createElement('li');
      li.innerHTML = `
        <div><strong>${p.descricao}</strong></div>
        <div class="muted">#${p.idproduto} • ${p.codbarras||'-'} • R$ ${fmt(p.precovenda||0)}</div>
        <div style="margin-top:6px; font-size:14px; color:#06c">Estoque: ${fmt(p.estdisponivel||0)}</div>
      `;
      li.onclick = ()=> carregarDetalhe(p.idproduto);
      lista.appendChild(li);
    });
    lista.scrollTop = 0;
  } catch(e){
    lista.innerHTML = `<li class="err">Erro ao buscar: ${e}</li>`;
  }
}

/* ====== CARREGAR DETALHE ====== */
async function carregarDetalhe(idproduto){
  detalhe.textContent = 'Carregando…';
  try {
    const r = await fetch(`${API_BASE}/produtos/${idproduto}/?empresa=${encodeURIComponent(document.getElementById('empresa').value||'1')}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const p = await r.json();
    produtoSel = p;
    detalhe.innerHTML = `
      <div style="font-size:20px; margin-bottom:8px; font-weight:bold">${p.descricao}</div>
      <div class="muted" style="margin-bottom:16px; font-size:14px">#${p.idproduto} • ${p.codbarras||'-'}</div>
      <div class="stock-info">
        <div style="margin-bottom:8px">Preço venda: <strong>R$ ${fmt(p.precovenda||0)}</strong></div>
        <div>Estoque atual: <strong id="stk" style="font-size:18px">${fmt(p.estdisponivel||0)}</strong></div>
      </div>
    `;
    ajusteBox.style.display = 'block';
    msg.innerHTML = '';
    quantidadeAtual = 1;
    updateQuantityDisplay();
    
    // Scroll suave para a seção de ajuste
    setTimeout(() => {
      ajusteBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
    
  } catch(e){
    detalhe.innerHTML = `<div class="err">Erro ao carregar: ${e}</div>`;
  }
}

/* ====== AJUSTE EM LOTE ====== */
async function confirmarLote(){
  if (!pendingItems.length) return;
  const usuario = getSavedUser();
  if (!usuario) { 
    msg.innerHTML = '<span class="err">Faça login para ajustar estoque</span>'; 
    showLoginModal(); 
    return; 
  }

  const body = {
    empresa: Number(document.getElementById('empresa').value || 1),
    idalmox: 1,
    usuario_id: Number(usuario.id),
    usuario_label: usuario.label,
    motivo: 'Ajuste em lote via PWA',
    items: pendingItems.map(it => ({ 
      idproduto: it.idproduto, 
      delta: Number(it.delta), 
      motivo: it.motivo || '' 
    }))
  };

  const confirmBtn = document.getElementById('btnConfirmLote');
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Enviando...';
  msg.innerHTML = '<div style="text-align:center">Enviando lote…</div>';

  try {
    const r = await fetch(`${API_BASE}/ajustar_lote/`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const ct = r.headers.get('content-type') || '';
    const js = ct.includes('application/json') ? await r.json() : {};
    
    if (!r.ok) { 
      msg.innerHTML = `<span class="err">Erro lote: ${js.detail || r.statusText}</span>`; 
      return; 
    }

    if (Array.isArray(js.results)) {
      const found = js.results.find(x => Number(x.idproduto) === Number(produtoSel && produtoSel.idproduto));
      if (found) {
        produtoSel.estdisponivel = found.saldo;
        const stk = document.getElementById('stk');
        if (stk) stk.textContent = fmt(produtoSel.estdisponivel);
      }
    }

    msg.innerHTML = `<div class="ok" style="font-weight:700">Lote aplicado (${pendingItems.length} itens).</div>`;
    pendingItems.length = 0;
    renderPending();
  } catch(e){
    msg.innerHTML = `<span class="err">Falha ao enviar lote: ${e}</span>`;
  } finally {
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Confirmar ajustes';
  }
}

/* ====== EVENTOS ====== */
btnBuscar.addEventListener('click', buscar);
q.addEventListener('keydown', e => { if (e.key === 'Enter') buscar(); });

btnIncrease.addEventListener('click', increaseQuantity);
btnDecrease.addEventListener('click', decreaseQuantity);

btnAdd.addEventListener('click', () => {
  if (!produtoSel) { 
    msg.innerHTML = '<span class="err">Selecione um produto.</span>'; 
    return; 
  }
  const qty = Math.max(1, parseInt(quantityDisplay.value, 10) || 1);
  pendingItems.push({ 
    idproduto: produtoSel.idproduto, 
    descricao: produtoSel.descricao, 
    delta: qty 
  });
  renderPending();
});

btnRem.addEventListener('click', () => {
  if (!produtoSel) { 
    msg.innerHTML = '<span class="err">Selecione um produto.</span>'; 
    return; 
  }
  const qty = Math.max(1, parseInt(quantityDisplay.value, 10) || 1);
  pendingItems.push({ 
    idproduto: produtoSel.idproduto, 
    descricao: produtoSel.descricao, 
    delta: -qty 
  });
  renderPending();
});

btnOpenLogin.addEventListener('click', ()=> { 
  carregarUsuariosModal().finally(()=> showLoginModal()); 
});

btnModalLogin.addEventListener('click', async ()=> { 
  await doLogin(); 
});

btnCancelLogin.addEventListener('click', ()=> hideLoginModal());

modalSenha.addEventListener('keydown', (e) => { 
  if (e.key === 'Enter') { 
    e.preventDefault(); 
    btnModalLogin.click(); 
  }
});

modalUsuario.addEventListener('keydown', (e) => { 
  if (e.key === 'Enter') { 
    e.preventDefault(); 
    modalSenha.focus(); 
  }
});

modalUsuario.addEventListener('change', ()=> setTimeout(()=> modalSenha.focus(), 50));

btnLogoutTop.addEventListener('click', ()=> logoutAndShowLogin());

loginOverlay.addEventListener('click', (e)=> { 
  if (e.target === loginOverlay) hideLoginModal(); 
});

/* ====== INICIALIZAÇÃO ====== */
lista.innerHTML = '<li>Digite e clique em Buscar…</li>';
updateQuantityDisplay();
renderPending();

(async function init(){
  const saved = getSavedUser();
  if (saved) setCurrentUser(saved.id, saved.label);
  else setCurrentUser(null);
  
  await carregarEmpresas();
  await carregarUsuariosModal();
  
  if (!saved) showLoginModal();
})();

/* PWA registration */
if ('serviceWorker' in navigator){
  navigator.serviceWorker.register("{% static 'js/serviceworker.js' %}").catch(()=>{});
}
</script>

</body>
</html>